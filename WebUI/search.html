<html>

<head>
    <link rel="stylesheet" type="text/css" href="style_search.css">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="viewport" content="user-scalable=no" />
</head>

<body>
    <div class="searchBar">
        <div class="box1">
            <input id="input1" type="text" class="input" placeholder="请输入作者">
        </div>
        <div class="box2">
            <input id="input2" type="text" class="input" placeholder="请输入角色">
        </div>
        <div class="box3">
            <input id="input3" type="text" class="input" placeholder="请输入其他tag">
        </div>
        <div class="searchButton">
            <input type="button" value="搜索" class="button" onclick="search()">
        </div>
        <select class="order">
            <option>id升序</option>
            <option>id降序</option>
            <option>点赞数降序</option>
            <option>点赞数升序</option>
            <option>随机</option>
        </select>
    </div>
    <div class='img_wrapper'>
        <div class='img_item'>
            <img class="main" src="" referrerPolicy="no-referrer">
            <div class="img_des">
                <div class="imd_des_tex">tags:</div>
                <div class="likes">
                    0
                </div>
            </div>
        </div>
        <div class='img_item'>
            <img class="main" src="" referrerPolicy="no-referrer">
            <div class="img_des">
                <div class="imd_des_tex">tags:</div>
                <div class="likes">
                    0
                </div>
            </div>
        </div>
        <div class='img_item'>
            <img class="main" src="" referrerPolicy="no-referrer">
            <div class="img_des">
                <div class="imd_des_tex">tags:</div>
                <div class="likes">
                    0
                </div>
            </div>
        </div>
        <div class='img_item'>
            <img class="main" src="" referrerPolicy="no-referrer">
            <div class="img_des">
                <div class="imd_des_tex">tags:</div>
                <div class="likes">
                    0
                </div>
            </div>
        </div>
        <div class='img_item'>
            <img class="main" src="" referrerPolicy="no-referrer">
            <div class="img_des">
                <div class="imd_des_tex">tags:</div>
                <div class="likes">
                    0
                </div>
            </div>
        </div>
        <div class='img_item'>
            <img class="main" src="" referrerPolicy="no-referrer">
            <div class="img_des">
                <div class="imd_des_tex">tags:</div>
                <div class="likes">
                    0
                </div>
            </div>
        </div>
        <div class='img_item'>
            <img class="main" src="" referrerPolicy="no-referrer">
            <div class="img_des">
                <div class="imd_des_tex">tags:</div>
                <div class="likes">
                    0
                </div>
            </div>
        </div>
        <div class='img_item'>
            <img class="main" src="" referrerPolicy="no-referrer">
            <div class="img_des">
                <div class="imd_des_tex">tags:</div>
                <div class="likes">
                    0
                </div>
            </div>
        </div>
        <div class='img_item'>
            <img class="main" src="" referrerPolicy="no-referrer">
            <div class="img_des">
                <div class="imd_des_tex">tags:</div>
                <div class="likes">
                    0
                </div>
            </div>
        </div>
        <div class='img_item'>
            <img class="main" src="" referrerPolicy="no-referrer">
            <div class="img_des">
                <div class="imd_des_tex">tags:</div>
                <div class="likes">
                    0
                </div>
            </div>
        </div>
        <div class='img_item'>
            <img class="main" src="" referrerPolicy="no-referrer">
            <div class="img_des">
                <div class="imd_des_tex">tags:</div>
                <div class="likes">
                    0
                </div>
            </div>
        </div>
        <div class='img_item'>
            <img class="main" src="" referrerPolicy="no-referrer">
            <div class="img_des">
                <div class="imd_des_tex">tags:</div>
                <div class="likes">
                    0
                </div>
            </div>
        </div>
        <div class='img_item'>
            <img class="main" src="" referrerPolicy="no-referrer">
            <div class="img_des">
                <div class="imd_des_tex">tags:</div>
                <div class="likes">
                    0
                </div>
            </div>
        </div>
        <div class='img_item'>
            <img class="main" src="" referrerPolicy="no-referrer">
            <div class="img_des">
                <div class="imd_des_tex">tags:</div>
                <div class="likes">
                    0
                </div>
            </div>
        </div>
        <div class='img_item'>
            <img class="main" src="" referrerPolicy="no-referrer">
            <div class="img_des">
                <div class="imd_des_tex">tags:</div>
                <div class="likes">
                    0
                </div>
            </div>
        </div>
        <div class='img_item'>
            <img class="main" src="" referrerPolicy="no-referrer">
            <div class="img_des">
                <div class="imd_des_tex">tags:</div>
                <div class="likes">
                    0
                </div>
            </div>
        </div>
        <div class='img_item'>
            <img class="main" src="" referrerPolicy="no-referrer">
            <div class="img_des">
                <div class="imd_des_tex">tags:</div>
                <div class="likes">
                    0
                </div>
            </div>
        </div>
        <div class='img_item'>
            <img class="main" src="" referrerPolicy="no-referrer">
            <div class="img_des">
                <div class="imd_des_tex">tags:</div>
                <div class="likes">
                    0
                </div>
            </div>
        </div>
        <div class='img_item'>
            <img class="main" src="" referrerPolicy="no-referrer">
            <div class="img_des">
                <div class="imd_des_tex">tags:</div>
                <div class="likes">
                    0
                </div>
            </div>
        </div>
        <div class='img_item'>
            <img class="main" src="" referrerPolicy="no-referrer">
            <div class="img_des">
                <div class="imd_des_tex">tags:</div>
                <div class="likes">
                    0
                </div>
            </div>
        </div>
    </div>
    <div class="page-icon">
        <button class="page-last" onclick="lastPage()">上一页<i></i></button>
        <span id="pageCurrent" class="page-current">1</span>
        <button class="page-next" onclick="nextPage()">下一页<i></i></button>
    </div>

</body>

</html>

<script>

    var url = "http://[240e:38b:8d7a:5100:102e:e0da:fd49:ba8]:1096/api/";

    var img_list = [];
    var imgs = document.getElementsByClassName("img_item")

    var author = "";
    var character = "";
    var tags = "";

    function openPic(img) {
        var id = 0;
        for (const i of img_list) {
            if (img == i["img"]) {
                id = i["id"];
            }
        }
        window.open(encodeURI('./singlepic.html?' + 'picid=' + id))
    }

    function like(img_likes) {
        var id = 0;
        for (const i of img_list) {
            if (img_likes == i["likes"]) {
                id = i["id"];
            }
        }
        var httpRequest = new XMLHttpRequest();
        httpRequest.open('POST', url, true);
        httpRequest.setRequestHeader("Content-type", "application/json; charset=utf-8");
        var obj = {
            "method": "like",
            "id": id
        };
        httpRequest.onload = function () {
            var json = httpRequest.responseText;
            var res = JSON.parse(json);
            if (res["message"] == ":)") {
                img_likes.innerHTML++;
            }
        }
        httpRequest.send(JSON.stringify(obj));
    }

    var data = decodeURI(document.URL)
    data = data.slice(data.indexOf("=") + 1)
    if (data == "random") {
        document.getElementsByClassName("order")[0].selectedIndex = 4;
        search();
    } else if (data != "") {
        data = data.split(";");
        console.log(data);
        document.getElementById("input1").value = data[0];
        document.getElementById("input2").value = data[1];
        document.getElementById("input3").value = data[2];
        document.getElementsByClassName("order")[0].selectedIndex = data[3];
        search();
    }

    for (const item of imgs) {
        var img = item.getElementsByTagName("img")[0];
        var img_des = item.getElementsByTagName("div")[0].getElementsByTagName("div")[0];
        var img_likes = item.getElementsByTagName("div")[0].getElementsByTagName("div")[1];
        img_list.push({ "img": img, "des": img_des, "likes": img_likes, "id": 0 });
        img.addEventListener("click", function (ev) {
            openPic(this);
        });
        img_likes.addEventListener("click", function (ev) {
            like(this);
        });
    }

    var pagenum = 1;

    function getImg(img, id) {
        var httpRequest = new XMLHttpRequest();
        httpRequest.open('POST', url, true);
        httpRequest.setRequestHeader("Content-type", "application/json; charset=utf-8");
        var obj = {
            "method": "getItemById",
            "id": id
        };
        httpRequest.onload = function () {
            var json = httpRequest.responseText;
            var res = JSON.parse(json);
            img["img"].src = res['url'];
            var tags_text = "";
            if (res['author'] != 0 && res['author'] != null) {
                tags_text += res['author'];
            }
            if (res['character'] != 0 && res['character'] != null) {
                tags_text += res['character'];
            }
            if (res['tags'] != 0 && res['tags'] != null) {
                tags_text += res['tags'];
            }
            img["des"].innerHTML = tags_text.substr(0, 30);
            img["likes"].innerHTML = res['likes'];
            img["id"] = id;
        }
        httpRequest.send(JSON.stringify(obj));
    }

    function search() {

        if (author != document.getElementById("input1").value.replaceAll(" ", "#")) {
            author = document.getElementById("input1").value.replaceAll(" ", "#");
            pagenum = 1;
            document.getElementById("pageCurrent").innerHTML = 1;
        }
        if (character != document.getElementById("input2").value.replaceAll(" ", "#")) {
            character = document.getElementById("input2").value.replaceAll(" ", "#");
            pagenum = 1;
            document.getElementById("pageCurrent").innerHTML = 1;
        }
        if (tags != document.getElementById("input3").value.replaceAll(" ", "#")) {
            tags = document.getElementById("input3").value.replaceAll(" ", "#");
            pagenum = 1;
            document.getElementById("pageCurrent").innerHTML = 1;
        }

        var order = document.getElementsByClassName("order")[0][document.getElementsByClassName("order")[0].selectedIndex].innerHTML;
        if (order == "随机") {
            order = "random"
        } else if (order == "id升序") {
            order = "id"
        } else if (order == "id降序") {
            order = "id_r"
        } else if (order == "点赞数升序") {
            order = "likes"
        } else if (order == "点赞数降序") {
            order = "likes_r"
        }
        var httpRequest = new XMLHttpRequest();
        httpRequest.open('POST', url, true);
        httpRequest.setRequestHeader("Content-type", "application/json; charset=utf-8");
        var obj = {
            "method": "searchByTag",
            "author": author,
            "character": character,
            "tags": tags,
            "page": pagenum,
            "order": order,
        };
        httpRequest.onload = function () {
            var json = httpRequest.responseText;
            var res = JSON.parse(json);
            var ids = res["ids"];
            for (const img of img_list) {
                img["img"].src = "";
            }
            for (i = 0; i < ids.length; i++) {
                getImg(img_list[i], ids[i]);
            }
        }
        httpRequest.send(JSON.stringify(obj));
    }

    function nextPage() {
        pagenum++;
        document.getElementById("pageCurrent").innerHTML++;
        search();
    }

    function lastPage() {
        if (pagenum > 1) {
            pagenum--;
            document.getElementById("pageCurrent").innerHTML--;
            search();
        }
    }

</script>